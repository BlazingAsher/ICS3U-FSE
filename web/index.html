<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>Blog Post - Start Bootstrap Template</title>

  <!-- Bootstrap core CSS -->
  <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom styles for this template -->
  <link href="css/blog-post.css" rel="stylesheet">

<style>
.spacer {
	height: 1em;
}

.hovercard:hover{
	background-color: #f4f4f4 !important;
	cursor: pointer;
}
</style>

</head>

<body>

<div style="position: relative; min-height: 100vh">
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container">
      <a class="navbar-brand" href="#">QwikSearch</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarResponsive">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item active">
            <a class="nav-link" href="#">Home
              <span class="sr-only">(current)</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">About</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">Services</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">Contact</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Page Content -->
  <div class="container">

    <div class="row">

      <!-- Post Content Column -->
      <div class="col-lg-8">

        <!-- Title -->
        <h1 class="mt-4">Results</h1>

        <hr>
	<div class="card my-4">
          <div class="card-body">
            <div class="input-group">
              <input type="text" class="form-control" placeholder="Search for..." id="searchQuery" selected>
              <span class="input-group-btn">
                <button class="btn btn-secondary" type="button" id="searchBtn">Go!</button>
              </span>
            </div>
			
          </div>
        </div>

        <hr>
		<div id="results">
		No results.
		</div>

        <hr>

      </div>

      <!-- Sidebar Widgets Column -->
      <div class="col-md-4">

        <!-- Categories Widget -->
        <div class="card my-4">
          <h5 class="card-header">File Types</h5>
          <div class="card-body">
            <div class="row">
              <div class="col-lg-6">
                <ul class="list-unstyled mb-0">
                  <li>
                    <a href="#">Web Design</a>
                  </li>
                  <li>
                    <a href="#">HTML</a>
                  </li>
                  <li>
                    <a href="#">Freebies</a>
                  </li>
                </ul>
              </div>
              <div class="col-lg-6">
                <ul class="list-unstyled mb-0">
                  <li>
                    <a href="#">JavaScript</a>
                  </li>
                  <li>
                    <a href="#">CSS</a>
                  </li>
                  <li>
                    <a href="#">Tutorials</a>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <!-- Side Widget -->
        <div class="card my-4">
          <h5 class="card-header">Search Options</h5>
          <div class="card-body">
            <div style="margin-top: 0.5em;">
			Search in: 
				<input type="radio" id="radio1" name="searchIn" value="filename" checked>
				<label for="radio1">Filename</label>
				<input type="radio" id="radio2" name="searchIn" value="path">
				<label for="radio2">Path</label>
			</div>
			<div style="margin-top: 0.5em;">
				Files Only: 
				<input type="checkbox" id="check1" name="searchIn" value="filename" checked>
				<label for="check1">Filename</label>
			</div>
          </div>
        </div>

      </div>

    </div>
    <!-- /.row -->

  </div>
  <!-- /.container -->

  <!-- Footer -->
  <footer class="py-5 bg-dark" style="margin-top: 7em">
    <div class="container">
      <p class="m-0 text-center text-white">Copyright &copy; 2019 David Hui and Sat Arora</p>
    </div>
    <!-- /.container -->
  </footer>
</div>
  <!-- Bootstrap core JavaScript -->
  <script src="vendor/jquery/jquery.min.js"></script>
  <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

<script>
var card = '<div class="card hovercard"><div class="card-body"><h5 class="card-title">document.docx</h5><p class="card-text">With supporting text below as a natural lead-in to additional content.</p></div></div><div class="spacer"></div>';

var currPage = 1;
var pageSize = 25;
var showFolders = false;

function getNext(){
	var query = makeRequest(currPage+1, pageSize);
	makeQuery(query, "next");
	
}

function getPrev(){
	if(currPage > 1){
		var query = makeRequest(currPage-1, pageSize);
		makeQuery(query, "prev");
	}
	
}

function procNext(data){
	if(data.data.length > 0){
		injectResults(data);
	}
	else{
		currPage--;
	}
}

function procPrev(data){
	injectResults(data);
}

function assembleCard(title, path){
	return '<div class="card hovercard"><div class="card-body"><h5 class="card-title">' + title +'</h5><p class="card-text">' + path +'</p></div></div><div class="spacer"></div>';
}

function injectResults(data){
	$("#results").empty();
	if(data.data.length > 0){
		for (var i=0;i<data.data.length;i++){
			$("#results").append(assembleCard(data.data[i]["subject"], data.data[i]["path"]));
		}
		
		
		if(currPage > 1){
			$("#results").append('<button class="btn btn-secondary" type="button" id="searchBtn" onclick="getPrev()" style="margin-right: 1em"><< Prev</button>');
		}
		if(data.data.length >= data["page_size"]){
			$("#results").append('<button class="btn btn-secondary" type="button" id="searchBtn" onclick="getNext()">Next >></button>');
		}
		
		
	}
	else{
		$("#results").append("No results.");
	}
	
	
}

function makeRequest(page=1, page_size=25){
	currPage = page;
	pageSize = page_size;
	console.log(currPage);
	var searchIn = $('input[name=searchIn]:checked').val();
	var query = {"operation": "getAllByQuery", "page": page, "page_size": page_size, "query": {"$and":[]}}
	if(searchIn == "path"){
		query["query"]["$and"].push({"path": {"$regex": $("#searchQuery").val()}});
	}
	else if(searchIn = "filename"){
		query["query"]["$and"].push({"subject": {"$regex": $("#searchQuery").val()}});
	}
	
	if(!showFolders){
		query["query"]["$and"].push({"properties.type": "file"});
	}
	return query;
}

function makeQuery(query, nextFunc="inject"){
	
	$.ajax({
		url: "http://127.0.0.1:5000/query/",
		data: JSON.stringify(query),
		contentType: 'application/json; charset=utf-8',
		dataType: 'json',
		type: 'POST',
		success: function (data) {
			if(nextFunc == "inject"){
				injectResults(data);
			}
			else if(nextFunc == "next"){
				procNext(data);
			}
			else if(nextFunc == "prev"){
				procPrev(data);
			}
		}
	});
}

$(function (){
	$("#searchQuery").select();

/*
	var query = {"operation": "getAll"}
	$.ajax({
        url: "http://127.0.0.1:5000/query/",
        data: JSON.stringify(query),
        contentType: 'application/json; charset=utf-8',
		dataType: 'json',
        type: 'POST',
        success: function (data) {
			console.log(data);
			
            injectResults(data);
        }
    });*/
	
	$("#searchQuery").keypress(function (e){
		var keycode = (e.keyCode ? e.keyCode : e.which);
		if(keycode == '13'){
			$("#searchBtn").click();
		}
	});
	
	$("#searchBtn").click(function (e){
		e.preventDefault();
		var query = makeRequest();
		makeQuery(query);
	});
	
});

$("#check1").change(function (){
	if(this.checked){
		showFolders = false;
	}
	else{
		showFolders = true;
	}
});
</script>
</body>

</html>
